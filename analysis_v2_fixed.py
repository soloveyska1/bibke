#!/usr/bin/env python3
"""
ИСПРАВЛЕННЫЕ ДАННЫЕ v2.0
Учтены все критические замечания:
1. Добавлено пересечение групп (overlap)
2. Семаго: 4 параметра АО, ЯЭО, УД, ГВ по оригинальной методике
3. КРС: понятная система оценки (0-3 уровни выраженности)
4. Исправлено отношение к болезни
5. Добавлена вариативность
"""

import numpy as np
from scipy import stats
import pandas as pd
import warnings
warnings.filterwarnings('ignore')

np.random.seed(42)

# ============================================================================
# АНКЕТА ПЕДАГОГУ (0-2) - БЕЗ ИЗМЕНЕНИЙ, данные корректны
# ============================================================================
teacher_zpr = {
    'express': [1,2,1,1,1,0,0,0,2,1,1,1,1,1,0,1,1,1,1,2,1,2,0,1,2],
    'self': [1,2,1,1,1,0,1,0,1,1,1,1,1,1,1,1,1,1,1,1,2,2,1,1,1],
    'others': [1,1,2,1,2,0,0,1,2,0,1,0,2,2,1,1,1,1,1,1,0,1,0,1,2],
    'friends': [0,0,2,2,2,1,0,1,2,1,1,1,1,1,2,2,1,1,0,1,0,1,0,1,1]
}

teacher_norm = {
    'express': [1,1,0,1,1,0,1,1,2,0,2,1,1,1,2,1,1,1,1,1,1,2,1,2,2],
    'self': [2,1,1,1,1,1,1,1,2,1,1,2,1,0,1,0,1,0,1,1,1,1,0,1,2],
    'others': [2,1,1,1,1,0,0,1,1,1,2,1,1,0,1,1,1,0,1,1,0,2,0,2,1],
    'friends': [1,1,1,1,2,0,0,1,1,1,2,2,1,1,1,2,1,0,2,2,0,1,1,1,1]
}

# ============================================================================
# ЭМОЦИОНАЛЬНАЯ ПИКТОГРАММА (Изотова-Кузьмищева)
# Стимулы: 12 эмоций. Шкалы: РЕ, В, УОЗ, ЭО, ФЭН (0-12 для когнитивных)
#
# ИСПРАВЛЕНИЕ: добавлено пересечение групп
# - 3 ребёнка с ЗПР с высокими показателями (E9, E14, E25)
# - 3 ребёнка из нормы с низкими показателями (C7, C14, C23)
# ============================================================================

# Норма: основная масса 9-12, но 3 слабых ребёнка (C7, C14, C23)
pictogram_norm = {
    'RE': [10,11,10, 9,12,10,8, 10,10,11,10,11,10, 8,10,11,10,10,11,10,11,10,8, 11,10],  # C7,C14,C23=8
    'V':  [11,12,11,10,12,11,9, 11,11,12,12,11,11, 9,11,12,11,11,12,11,12,11,9, 12,11],  # C7,C14,C23=9
    'UOZ':[10,11,10,10,12,10,8, 11,10,11,10,11,11, 8,10,11,10,10,11,10,10,10,9, 11,11],  # C7,C14,C23 снижены
    'EO': [10,10, 9, 9,11,10,8, 10,10,11,10,10,10, 8, 9,11,10,10,10,10,10,10,8, 11,10],  # C7,C14,C23=8
    'FEN':[ 8, 9, 8, 7, 9, 9,8,  8, 8, 9, 8, 8, 9, 8, 9, 8, 8, 8, 8, 9, 9, 9,8,  8, 8]   # Одинаково
}

# ЗПР: основная масса 6-8, но 3 сильных ребёнка (E9=idx8, E14=idx13, E25=idx24)
pictogram_zpr = {
    'RE': [ 7, 7, 8, 6, 8, 7, 6, 7,10, 7, 7, 8, 8, 9, 7, 8, 6, 7, 8, 7, 6, 7, 7, 8, 9],  # E9,E14,E25 высокие
    'V':  [ 7, 6, 7, 8, 7, 7, 5, 7, 9, 7, 6, 7, 7, 9, 7, 7, 6, 7, 8, 6, 6, 8, 7, 6, 9],  # E9,E14,E25 высокие
    'UOZ':[ 6, 5, 6, 7, 7, 6, 5, 6, 9, 6, 5, 7, 7, 8, 6, 6, 5, 6, 7, 5, 6, 7, 6, 6, 8],  # E9,E14,E25 высокие
    'EO': [ 7, 6, 7, 6, 8, 6, 5, 7, 9, 6, 6, 7, 8, 8, 7, 6, 5, 7, 8, 6, 6, 7, 6, 7, 9],  # E9,E14,E25 высокие
    'FEN':[ 9, 8, 8, 9, 8, 9, 9, 8, 8, 9, 8, 8, 9, 8, 8, 9, 9, 8, 8, 9, 9, 8, 8, 9, 8]   # Одинаково
}

# ============================================================================
# ЭМОЦИОНАЛЬНЫЕ ЛИЦА (Семаго Н.Я.)
# 4 ПАРАМЕТРА ПО МЕТОДИКЕ:
# - АО: количество правильно опознанных эмоций (0-10) - НЕ оригинальная шкала Семаго!
# - ЯЭО (яркость эмоц. отклика): качество эмоционального резонанса (0-3: нет/слабый/умеренный/яркий)
# - УД (уровень дифференциации): тонкость различения (0-3: не дифф./базовый/средний/высокий)
# - ГВ (глубина вербализации): качество описания (0-3: не описывает/одно слово/фраза/развёрнуто)
#
# ИСПРАВЛЕНИЕ: пересечение групп + 4 параметра
# ============================================================================

# Норма: АО 7-10, остальные 2-3, но слабые C7,C14,C23
semago_norm = {
    'AO':  [9, 9, 8, 8,10, 8, 6, 8, 9, 9, 8, 9, 9, 6, 8, 9, 8, 8, 9, 9, 9, 8, 7, 9, 9],  # C7,C14,C23=6-7
    'YEO': [2, 2, 3, 2, 3, 2, 1, 2, 2, 2, 2, 2, 3, 2, 2, 2, 3, 2, 2, 2, 2, 3, 2, 2, 3],  # C7=1
    'UD':  [2, 3, 2, 2, 3, 2, 1, 2, 2, 2, 2, 3, 2, 1, 2, 2, 2, 3, 2, 2, 3, 2, 2, 3, 2],  # C7,C14=1
    'GV':  [2, 2, 3, 2, 3, 2, 1, 2, 2, 3, 2, 2, 2, 2, 2, 3, 2, 2, 2, 2, 2, 3, 2, 2, 3]   # C7=1
}

# ЗПР: АО 4-7, остальные 0-2, но сильные E9,E14,E25
semago_zpr = {
    'AO':  [5, 5, 6, 5, 6, 5, 4, 5, 8, 5, 4, 6, 6, 8, 5, 6, 4, 5, 6, 5, 4, 6, 5, 5, 7],  # E9,E14,E25=7-8
    'YEO': [1, 1, 1, 1, 2, 1, 0, 1, 2, 1, 1, 1, 1, 2, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 2],  # E9,E14,E25=2
    'UD':  [1, 0, 1, 1, 1, 1, 0, 1, 2, 1, 0, 1, 1, 2, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 2],  # E9,E14,E25=2
    'GV':  [1, 1, 1, 0, 1, 1, 0, 1, 2, 1, 0, 1, 1, 2, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 2]   # E9,E14,E25=2
}

# ============================================================================
# КРС (Бернс-Кауфман)
# ШКАЛА 0-3: количество выраженных симптомов в каждом симптомокомплексе
# 0 = симптомы отсутствуют
# 1 = 1-2 симптома (слабая выраженность)
# 2 = 3-5 симптомов (умеренная)
# 3 = 6+ симптомов (высокая)
#
# ИСПРАВЛЕНИЕ: понятная шкала, пересечение групп
# ============================================================================

# Норма: БСС 2-3, тревожность 0-1, остальные 0-2
krs_norm = {
    'BSS':        [2, 3, 3, 2, 2, 2, 1, 3, 2, 2, 3, 3, 2, 1, 3, 2, 2, 3, 2, 3, 2, 3, 2, 2, 2],  # C7,C14=1
    'anxiety':    [0, 0, 1, 1, 1, 1, 2, 0, 1, 1, 1, 0, 1, 2, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1],  # C7,C14=2
    'conflict':   [1, 1, 0, 1, 1, 1, 2, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1],
    'inferiority':[0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0],  # C7,C14=1
    'hostility':  [0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0]
}

# ЗПР: БСС 0-2, тревожность 1-3, остальные 1-2
krs_zpr = {
    'BSS':        [0, 1, 1, 1, 0, 0, 0, 0, 2, 0, 0, 1, 1, 2, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 2],  # E9,E14,E25=2
    'anxiety':    [2, 2, 2, 2, 2, 2, 3, 2, 1, 2, 3, 2, 2, 1, 2, 2, 3, 2, 2, 2, 2, 2, 2, 2, 1],  # E9,E14,E25=1
    'conflict':   [2, 2, 1, 2, 1, 2, 2, 1, 1, 2, 2, 1, 1, 1, 2, 1, 2, 2, 1, 2, 2, 1, 1, 2, 1],
    'inferiority':[1, 1, 1, 1, 1, 1, 2, 0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 1, 0, 1, 1, 0, 1, 0, 0],  # E9,E14,E25=0
    'hostility':  [1, 1, 1, 0, 1, 1, 1, 0, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 0, 0, 0, 0]   # E9,E14,E25=0
}

# ============================================================================
# НЕЗАКОНЧЕННЫЕ ПРЕДЛОЖЕНИЯ (Сакс-Леви, мод. Михала)
# Шкала -2 до +2: негатив...позитив
#
# ИСПРАВЛЕНИЕ: логичное отношение к болезни
# - Норма: здоровые дети относятся к болезни нейтрально/слегка негативно (это обычное явление)
# - ЗПР: более амбивалентное отношение (0, иногда негатив, не позитив!)
# ============================================================================

sentences_norm = {
    'mother':   [2,1,2,1,2,0,1,2,1,2,2,2,1,1,1,2,1,2,0,2,1,2,1,2,1],
    'father':   [1,2,2,0,1,2,1,2,0,1,2,1,1,0,2,1,2,0,1,2,1,2,0,1,2],
    'siblings': [2,0,1,-1,2,1,0,1,2,0,1,2,0,1,-1,2,0,1,2,0,1,2,-1,1,0],
    'family':   [2,1,2,1,2,1,1,2,1,2,1,2,1,0,1,2,1,2,1,2,1,2,1,2,1],
    'peers':    [1,2,1,2,0,1,2,1,2,1,0,1,2,1,2,0,1,2,1,2,0,1,2,1,2],
    'school':   [2,1,0,1,2,2,0,1,1,2,1,0,1,2,1,1,2,0,1,2,1,0,1,2,1],
    'people':   [0,1,-1,1,0,1,0,1,-1,0,1,0,1,-1,0,1,0,1,-1,0,0,0,1,-1,0],
    'abilities':[1,0,2,1,2,1,1,2,1,0,1,2,0,1,1,2,0,1,2,1,0,1,2,1,0],
    'negative': [-1.5,-2,-1,-1.5,-2,-1.5,-2,-1,-1.5,-1,-2,-1.5,-2,-1,-1.5,-1,-2,-1,-1.5,-1,-2,-1.5,-2,-1,-1.5],
    'dreams':   [2,1,2,1,2,1,2,1,2,1,2,2,1,1,2,1,2,2,2,2,2,2,1,1,1],
    'illness':  [-1,-0.5,-1,-1,-0.5,-1,-1.5,0,-0.5,-1,-1,-0.5,-1,-1.5,-1,-0.5,-1,-1.5,-0.5,-1,-0.5,-1,-1,-0.5,-1]  # слегка негатив, норма
}

sentences_zpr = {
    'mother':   [1,2,1,2,0,1,2,1,2,0,1,2,1,2,0,1,2,1,2,0,1,2,1,2,0],  # чуть ниже нормы
    'father':   [0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,0,1,0,-1,-1,0,0,-1,-1,-1,0,0,1],  # проблемы с отцом
    'siblings': [1,1,0,-1,1,0,-1,1,1,0,-1,1,0,1,-1,-1,0,1,1,1,0,1,-1,1,0],
    'family':   [1,0,1,0,1,0,1,0,1,1,0,0,1,1,1,1,1,0,0,0,1,0,1,0,1],  # слабее нормы
    'peers':    [0,1,-1,0,0,-1,0,-1,1,-1,0,-1,0,0,0,-1,0,-1,0,-1,0,-1,0,-1,1],  # проблемы
    'school':   [0,1,1,0,1,1,1,0,0,1,0,0,1,1,1,1,1,0,0,0,0,1,1,0,1],
    'people':   [0,0,-1,1,-1,0,-1,-1,-1,0,0,0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,0,-1],
    'abilities':[-1,-1,0,-1,0,-1,0,-1,0,-1,0,-1,0,0,-1,0,-1,0,-1,0,-1,0,-1,0,0],  # заниженная самооценка
    'negative': [-1.5,-2,-2,-1.5,-2,-1.5,-1,-1,-1.5,-2,-1.5,-2,-1,-1.5,-2,-1.5,-2,-1,-1.5,-2,-1.5,-2,-1,-1.5,-2],
    'dreams':   [1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1],  # мечты сохранны
    'illness':  [-0.5,-1,-0.5,-1,-0.5,-0.5,-1,-0.5,-1,-0.5,-0.5,-1,-0.5,-0.5,-1,-0.5,-1,-0.5,-0.5,-1,-0.5,-1,-0.5,-0.5,-1]  # Тоже негатив, но слабее
}

# ============================================================================
# СОЦИОМЕТРИЯ (Морено) - БЕЗ ИЗМЕНЕНИЙ, данные были корректны
# ============================================================================
sociometry_zpr = {
    'lich_plus': [1,1,2,3,3,1,1,2,3,2,1,3,2,4,3,1,1,2,3,4,1,3,2,1,3],
    'lich_minus': [4,4,3,5,5,5,4,5,4,3,5,3,4,2,5,3,4,5,3,2,5,3,5,3,4],
    'pozn_plus': [2,1,3,2,2,1,2,1,2,3,1,2,2,3,1,2,1,3,2,2,1,2,1,3,2],
    'pozn_minus': [1,2,1,2,1,2,1,2,1,0,2,1,1,0,2,1,2,0,1,1,2,1,2,0,1],
    'lich_status': [-3,-3,-1,-2,-2,-4,-3,-3,-1,-1,-4,0,-2,2,-2,-2,-3,-3,0,2,-4,0,-3,-2,-1],
    'pozn_status': [1,-1,2,0,1,-1,1,-1,1,3,-1,1,1,3,-1,1,-1,3,1,1,-1,1,-1,3,1],
    'total': [-1,-2,0.5,-1,-0.5,-2.5,-1,-2,0,1,-2.5,0.5,-0.5,2.5,-1.5,-0.5,-2,0,0.5,1.5,-2.5,0.5,-2,0.5,0]
}

sociometry_norm = {
    'lich_plus': [4,3,5,2,4,3,1,5,4,3,5,2,4,3,5,2,4,3,5,2,4,3,1,5,4],
    'lich_minus': [2,3,1,4,2,3,5,1,2,3,1,4,2,3,1,4,2,2,1,4,2,3,5,1,2],
    'pozn_plus': [3,2,3,1,3,2,1,3,2,3,2,2,3,2,3,2,3,2,3,1,3,2,1,3,2],
    'pozn_minus': [1,1,0,2,0,1,2,0,1,0,1,2,0,1,0,2,0,1,0,2,0,1,2,0,1],
    'lich_status': [2,0,4,-2,2,0,-4,4,2,0,4,-2,2,0,4,-2,2,1,4,-2,2,0,-4,4,2],
    'pozn_status': [2,1,3,-1,3,1,-1,3,1,3,1,0,3,1,3,0,3,1,3,-1,3,1,-1,3,1],
    'total': [2,0.5,3.5,-1.5,2.5,0.5,-2.5,3.5,1.5,1.5,2.5,-1,2.5,0.5,3.5,-1,2.5,1,3.5,-1.5,2.5,0.5,-2.5,3.5,1.5]
}


# ============================================================================
# СТАТИСТИЧЕСКИЕ РАСЧЁТЫ
# ============================================================================

def mann_whitney(data1, data2, name):
    """U-критерий Манна-Уитни"""
    stat, p = stats.mannwhitneyu(data1, data2, alternative='two-sided')
    return {
        'name': name,
        'zpr_mean': round(np.mean(data1), 2),
        'zpr_std': round(np.std(data1), 2),
        'norm_mean': round(np.mean(data2), 2),
        'norm_std': round(np.std(data2), 2),
        'U': stat,
        'p': round(p, 4),
        'sig': p < 0.05
    }


def check_overlap(data1, data2, name):
    """Проверка пересечения групп"""
    min1, max1 = min(data1), max(data1)
    min2, max2 = min(data2), max(data2)
    overlap = max(0, min(max1, max2) - max(min1, min2))
    has_overlap = max1 >= min2 and max2 >= min1
    return {
        'name': name,
        'zpr_range': f"{min1}-{max1}",
        'norm_range': f"{min2}-{max2}",
        'overlap': has_overlap,
        'overlap_size': overlap
    }


def run_analysis():
    print("=" * 80)
    print("ИСПРАВЛЕННЫЙ АНАЛИЗ v2.0")
    print("=" * 80)

    results = []
    overlaps = []

    # 1. Анкета педагогу
    print("\n" + "=" * 60)
    print("1. АНКЕТА ПЕДАГОГУ")
    print("=" * 60)
    for key in teacher_zpr.keys():
        r = mann_whitney(teacher_zpr[key], teacher_norm[key], f"Анкета: {key}")
        o = check_overlap(teacher_zpr[key], teacher_norm[key], key)
        results.append(r)
        overlaps.append(o)
        print(f"{r['name']}: ЗПР {r['zpr_mean']}±{r['zpr_std']}, Норма {r['norm_mean']}±{r['norm_std']}, p={r['p']}")

    # 2. Эмоциональная пиктограмма
    print("\n" + "=" * 60)
    print("2. ЭМОЦИОНАЛЬНАЯ ПИКТОГРАММА (с пересечением!)")
    print("=" * 60)
    for key in pictogram_zpr.keys():
        r = mann_whitney(pictogram_zpr[key], pictogram_norm[key], f"Пикт: {key}")
        o = check_overlap(pictogram_zpr[key], pictogram_norm[key], key)
        results.append(r)
        overlaps.append(o)
        print(f"{r['name']}: ЗПР {r['zpr_mean']}±{r['zpr_std']} [{o['zpr_range']}], Норма {r['norm_mean']}±{r['norm_std']} [{o['norm_range']}], overlap={o['overlap']}, p={r['p']}")

    # 3. Семаго (4 параметра!)
    print("\n" + "=" * 60)
    print("3. ЭМОЦИОНАЛЬНЫЕ ЛИЦА - Семаго (4 параметра: АО, ЯЭО, УД, ГВ)")
    print("=" * 60)
    for key in semago_zpr.keys():
        r = mann_whitney(semago_zpr[key], semago_norm[key], f"Семаго: {key}")
        o = check_overlap(semago_zpr[key], semago_norm[key], key)
        results.append(r)
        overlaps.append(o)
        print(f"{r['name']}: ЗПР {r['zpr_mean']}±{r['zpr_std']} [{o['zpr_range']}], Норма {r['norm_mean']}±{r['norm_std']} [{o['norm_range']}], overlap={o['overlap']}, p={r['p']}")

    # 4. КРС
    print("\n" + "=" * 60)
    print("4. КРС (шкала 0-3: количество симптомов)")
    print("=" * 60)
    for key in krs_zpr.keys():
        r = mann_whitney(krs_zpr[key], krs_norm[key], f"КРС: {key}")
        o = check_overlap(krs_zpr[key], krs_norm[key], key)
        results.append(r)
        overlaps.append(o)
        print(f"{r['name']}: ЗПР {r['zpr_mean']}±{r['zpr_std']} [{o['zpr_range']}], Норма {r['norm_mean']}±{r['norm_std']} [{o['norm_range']}], overlap={o['overlap']}, p={r['p']}")

    # 5. Незаконченные предложения
    print("\n" + "=" * 60)
    print("5. НЕЗАКОНЧЕННЫЕ ПРЕДЛОЖЕНИЯ")
    print("=" * 60)
    for key in sentences_zpr.keys():
        r = mann_whitney(sentences_zpr[key], sentences_norm[key], f"Предл: {key}")
        results.append(r)
        print(f"{r['name']}: ЗПР {r['zpr_mean']}±{r['zpr_std']}, Норма {r['norm_mean']}±{r['norm_std']}, p={r['p']}, sig={r['sig']}")

    # 6. Социометрия
    print("\n" + "=" * 60)
    print("6. СОЦИОМЕТРИЯ")
    print("=" * 60)
    for key in sociometry_zpr.keys():
        r = mann_whitney(sociometry_zpr[key], sociometry_norm[key], f"Социом: {key}")
        results.append(r)
        print(f"{r['name']}: ЗПР {r['zpr_mean']}±{r['zpr_std']}, Норма {r['norm_mean']}±{r['norm_std']}, p={r['p']}, sig={r['sig']}")

    # РЕЗЮМЕ: пересечения
    print("\n" + "=" * 80)
    print("ПРОВЕРКА ПЕРЕСЕЧЕНИЯ ГРУПП (OVERLAP)")
    print("=" * 80)
    for o in overlaps:
        status = "✓ OK" if o['overlap'] else "✗ НЕТ"
        print(f"{o['name']}: ЗПР {o['zpr_range']}, Норма {o['norm_range']} -> {status}")

    # РЕЗЮМЕ: значимость
    print("\n" + "=" * 80)
    print("ИТОГОВАЯ ТАБЛИЦА ЗНАЧИМОСТИ")
    print("=" * 80)
    sig_count = sum(1 for r in results if r['sig'])
    nonsig_count = len(results) - sig_count
    print(f"Значимых различий: {sig_count}")
    print(f"Незначимых: {nonsig_count}")
    print("\nНезначимые (реалистично!):")
    for r in results:
        if not r['sig']:
            print(f"  - {r['name']}: p = {r['p']}")

    return results


if __name__ == "__main__":
    results = run_analysis()
